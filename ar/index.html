<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SEO -->
  <title>محوّل صيغ الصور مجانًا | تحويل JPG و PNG و WebP و ICO أونلاين (بدون تسجيل)</title>
  <meta name="description" content="مجاني للأبد، بدون تسجيل أو رفع ملفات. تحويل سريع بين JPG و PNG و WebP و ICO مع دعم الدُفعات، تغيير الحجم، وتنزيل ZIP. كل المعالجة محليًا داخل المتصفح." />

  <!-- Canonical & Hreflang -->
  <link rel="canonical" href="https://www.freeimageconverter.net/ar/" />
  <link rel="alternate" hreflang="en" href="https://www.freeimageconverter.net/" />
  <link rel="alternate" hreflang="ar" href="https://www.freeimageconverter.net/ar/" />
  <link rel="alternate" hreflang="x-default" href="https://www.freeimageconverter.net/" />

  <meta name="theme-color" content="#0b0c10" />

  <!-- PWA / Icons (root-relative for subfolder safety) -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link rel="icon" href="/icon-192.png" sizes="192x192" type="image/png">
  <link rel="icon" href="/favicon.ico">

  <!-- Preconnect -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://www.googletagmanager.com">

  <!-- Open Graph -->
  <meta property="og:title" content="محوّل صيغ الصور مجانًا | تحويل JPG و PNG و WebP و ICO أونلاين (بدون تسجيل)" />
  <meta property="og:description" content="مجاني للأبد · بدون تسجيل · بدون رفع. سحب وإفلات، دُفعات، تغيير حجم، وتنزيل ZIP. كل شيء محلي داخل المتصفح." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.freeimageconverter.net/ar/" />
  <meta property="og:image" content="https://www.freeimageconverter.net/og.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:locale" content="ar_SA" />
  <meta property="og:locale:alternate" content="en_US" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="محوّل صيغ الصور مجانًا | تحويل JPG و PNG و WebP و ICO أونلاين (بدون تسجيل)" />
  <meta name="twitter:description" content="مجاني للأبد · بدون تسجيل · بدون رفع. سحب وإفلات، دُفعات، تغيير حجم، وتنزيل ZIP. 100% داخل المتصفح." />
  <meta name="twitter:image" content="https://www.freeimageconverter.net/og.png" />

  <!-- JSON-LD: WebApplication -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebApplication",
    "name":"Free Image Converter",
    "applicationCategory":"MultimediaApplication",
    "operatingSystem":"Any",
    "url":"https://www.freeimageconverter.net/ar/",
    "inLanguage":["ar","en"],
    "description":"محوّل صور يعمل بالكامل داخل المتصفح (JPG, PNG, WebP, ICO) مع دعم الدُفعات، تغيير الحجم، وتنزيل ZIP. بدون تسجيل أو رفع ملفات.",
    "offers":{"@type":"Offer","price":"0","priceCurrency":"USD"}
  }
  </script>

  <!-- JSON-LD: FAQPage -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "@id":"https://www.freeimageconverter.net/ar/#faq",
    "mainEntity":[
      {"@type":"Question","name":"كيف أحوّل JPG إلى PNG مجانًا؟","acceptedAnswer":{"@type":"Answer","text":"اسحب وأسقط ملف JPG، اختر PNG كصيغة إخراج، ثم اضغط تحويل. لا حاجة للتسجيل أو الرفع."}},
      {"@type":"Question","name":"هل أستطيع تحويل WebP إلى ICO بدون تسجيل؟","acceptedAnswer":{"@type":"Answer","text":"نعم. اختر صورة WebP، وحدّد الإخراج ICO ‏(256×256)، ثم نزّله فورًا. كل شيء يعمل داخل متصفحك."}},
      {"@type":"Question","name":"هل يدعم الأداة الصور الكبيرة؟","acceptedAnswer":{"@type":"Answer","text":"نعم. تتم المعالجة محليًا عبر Canvas API. الحد الأساسي هو ذاكرة جهازك."}},
      {"@type":"Question","name":"هل الأداة مجانية دائمًا وبدون حساب؟","acceptedAnswer":{"@type":"Answer","text":"نعم، مجانية 100% ومدعومة بالإعلانات. لا يتطلب حسابًا أو تسجيلًا."}},
      {"@type":"Question","name":"هل يمكن تحويل عدة صور دفعة واحدة وتنزيلها كملف ZIP؟","acceptedAnswer":{"@type":"Answer","text":"نعم. أضف عدة ملفات، اضغط تحويل، ثم يمكنك تنزيل كل ملف أو تنزيل الكل كأرشيف ZIP."}}
    ]
  }
  </script>

  <!-- JSON-LD: WebSite (optional) -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebSite",
    "name":"Free Image Converter",
    "url":"https://www.freeimageconverter.net/",
    "inLanguage":["ar","en"]
  }
  </script>

  <style>
    :root{
      --bg:#0b0c10; --bg-soft:#111318; --card:#151822; --muted:#8a93a2; --text:#e9edf5;
      --accent:#4f8cff; --accent-2:#16c79a; --danger:#ff5c7a; --border:#242836; --shadow:0 10px 30px rgba(0,0,0,.35);
      color-scheme: light dark;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f7f8fb; --bg-soft:#eef1f7; --card:#fff; --muted:#5d6576; --text:#121521; --border:#e6e9f0; --shadow:0 10px 24px rgba(14,22,36,.08) }
    }
    [data-theme="light"]{
      --bg:#f7f8fb; --bg-soft:#eef1f7; --card:#fff; --muted:#5d6576; --text:#121521; --border:#e6e9f0; --shadow:0 10px 24px rgba(14,22,36,.08)
    }
    [data-theme="dark"]{
      --bg:#0b0c10; --bg-soft:#111318; --card:#151822; --muted:#8a93a2; --text:#e9edf5; --border:#242836; --shadow:0 10px 30px rgba(0,0,0,.35)
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"}
    a{color:var(--accent);text-decoration:none}
    header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(1.2) blur(6px);background:color-mix(in oklab,var(--bg) 70%,transparent);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .hero{display:grid;grid-template-columns:1fr 320px;gap:16px;align-items:center}
    @media (max-width:980px){.hero{grid-template-columns:1fr}}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--shadow)}
    .brand h1{margin:0;font-size:1.25rem}
    .badge{margin-right:8px;font-size:.85rem;color:white;background:linear-gradient(135deg,var(--accent),var(--accent-2));padding:4px 8px;border-radius:999px}
    .lang-toggle,.theme-toggle{margin-right:auto;display:flex;gap:8px;align-items:center}
    .lang-toggle a,.theme-toggle button,.lang-toggle button{border:1px solid var(--border);background:var(--card);color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .card .pad{padding:18px}
    main .grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media (max-width:980px){main .grid{grid-template-columns:1fr}}
    .controls{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media (max-width:980px){.controls{grid-template-columns:1fr 1fr}}
    @media (max-width:520px){.controls{grid-template-columns:1fr}}
    label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select,input[type="color"],input[type="range"],input[type="file"],input[type="number"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--bg-soft);color:var(--text)}
    input[type="range"]{padding:0;height:40px}
    .hint{color:var(--muted);font-size:12px}
    .buttons{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .btn{border:1px solid var(--border);background:var(--accent);color:white;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600;box-shadow:var(--shadow);font-size:1.05rem;display:inline-flex;align-items:center;gap:8px}
    .btn.secondary{background:var(--bg-soft);color:var(--text);opacity:.95}
    .btn.danger{background:var(--danger)}
    .btn:focus{outline:none;box-shadow:0 0 0 3px color-mix(in oklab,var(--accent) 35%, transparent)}
    .drop{border:2px dashed var(--border);border-radius:14px;padding:24px;text-align:center;background:repeating-linear-gradient(-45deg,color-mix(in oklab,var(--card) 95%,transparent),color-mix(in oklab,var(--card) 95%,transparent) 8px,transparent 8px,transparent 16px);transition:background .15s ease,border-color .15s ease;color:var(--muted)}
    .drop.dragover{border-color:var(--accent);background:color-mix(in oklab,var(--accent) 10%,var(--card) 90%)}
    .list{width:100%;border-collapse:collapse}
    .list th,.list td{border-bottom:1px solid var(--border);padding:10px;vertical-align:middle}
    .thumb{width:52px;height:52px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
    .ad-slot{background:var(--bg-soft);border:1px dashed var(--border);border-radius:16px;display:grid;place-items:center;color:var(--muted)}
    #adTop{min-height:90px}
    .ad-slot.incontent{min-height:250px}
    .ad-slot.sidebar{min-height:250px}

    .toast{position:fixed;bottom:18px;right:50%;transform:translateX(50%) translateY(20px);background:var(--card);color:var(--text);border:1px solid var(--border);padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:transform .2s ease,opacity .2s ease}
    .toast.show{opacity:1;transform:translateX(50%) translateY(0);pointer-events:auto}
    .progress{height:10px;background:var(--bg-soft);border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2))}
    footer{color:var(--muted);font-size:12px;padding:24px 0;text-align:center}
    .nowrap{white-space:nowrap}
    dialog{border:none;border-radius:16px;background:var(--card);color:var(--text);box-shadow:var(--shadow);max-width:720px}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .modal-actions{display:flex;justify-content:flex-start;gap:10px;margin-top:12px}
    #contactDlg input[type="email"], #contactDlg textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--bg-soft);color:var(--text)}

    .preview-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:980px){.preview-grid{grid-template-columns:1fr}}
    .preview-card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px}
    .preview-meta{color:var(--muted);font-size:12px;margin-top:6px}
    .preview-canvas{width:100%;height:auto;display:block;max-height:380px;background:repeating-conic-gradient(from 0deg, #ccc 0% 25%, #eee 0% 50%) 50%/16px 16px}
    [data-theme="dark"] .drop{background:color-mix(in oklab,var(--card) 92%, transparent)}
    [data-theme="dark"] .btn.secondary{background:color-mix(in oklab,var(--bg-soft) 80%, transparent)}
    .icon{width:18px;height:18px;display:inline-block;vertical-align:middle}
  
    /* Button icon layout (unified) */
    .btn{ display:inline-flex; align-items:center; gap:8px; }
    .btn .icon-emoji{ font-size:18px; line-height:1; }
    html[dir="rtl"] .btn{ flex-direction: row; }
    
</style>

  <!-- Google Analytics 4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZT3BHHBZQ3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag("js", new Date());
    gtag("config", "G-ZT3BHHBZQ3", { anonymize_ip: true, send_page_view: true });
  </script>
</head>

<body>
<script>
  // تحميل المكتبات عند الحاجة
  function loadScript(src){
    return new Promise((resolve, reject)=>{
      const s = document.createElement('script');
      s.src = src; s.async = true;
      s.onload = resolve; s.onerror = reject;
      document.head.appendChild(s);
    });
  }
  async function ensureZipLibs(){
    if(!window.JSZip){
      await loadScript('https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js');
    }
    if(!window.saveAs){
      await loadScript('https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js');
      if(typeof window.saveAs!=='function'){
        window.saveAs=function(b,n){
          const a=document.createElement('a'),u=URL.createObjectURL(b);
          a.href=u;a.download=n||'download';document.body.appendChild(a);a.click();a.remove();
          setTimeout(()=>URL.revokeObjectURL(u),1000);
        };
      }
    }
  }
</script>

  <header>
    <div class="wrap hero">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1 id="appTitle">محوّل صيغ الصور</h1>
        <span class="badge" id="freeBadge">مجاني دائمًا · بدون تسجيل</span>
        <div class="theme-toggle" role="group" aria-label="السمة">
          <button id="themeLight" aria-pressed="false" type="button" aria-label="الوضع الفاتح">فاتح</button>
          <button id="themeDark" aria-pressed="false" type="button" aria-label="الوضع الداكن">داكن</button>
          <button id="themeAuto" aria-pressed="true" type="button" aria-label="سمة النظام">تلقائي</button>
        </div>
        <div class="lang-toggle" role="group" aria-label="اللغة" style="margin-right:8px">
          <a id="btnEN" href="/" aria-label="English">EN</a>
          <button id="btnAR" aria-pressed="true" type="button" aria-label="العربية">AR</button>
        </div>
      </div>
      <aside class="ad-slot" id="adTop" aria-label="إعلان">
        <span>مساحة إعلان — 728×90 / متجاوب</span>
      </aside>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card">
        <div class="pad">
          <p id="lead">مجاني للأبد. بدون تسجيل أو رفع. حوّل بين ‎JPG‎ و‎PNG‎ و‎WebP‎ و‎ICO مع السحب والإفلات، معالجة دُفعية، تغيير الحجم اختياري، وتنزيل ZIP. مدعوم بالإعلانات.</p>

          <!-- الخيارات -->
          <div class="controls" aria-label="خيارات التحويل">
            <div>
              <label class="small" for="fmtSelect" id="lblFormat">صيغة الإخراج</label>
              <select id="fmtSelect" aria-label="اختر صيغة الإخراج">
                <option value="png">PNG</option>
                <option value="jpg" selected>JPG</option>
                <option value="webp">WebP</option>
                <option value="ico">ICO (256×256)</option>
              </select>
              <div class="hint" id="fmtHint">يمكن ضبط الجودة لملفي JPG وWebP. ملف ICO عبارة عن ‎PNG بحجم ‎256×256 داخل حاوية ICO.</div>
            </div>

            <div id="qualityWrap">
              <label class="small" for="quality" id="lblQuality">الجودة (JPG/WebP)</label>
              <input type="range" id="quality" min="0.1" max="1" step="0.01" value="0.92" aria-label="مؤشر الجودة" />
              <div class="hint"><span id="qualityVal">0.92</span></div>
            </div>

            <div id="bgWrap">
              <label class="small" for="bgColor" id="lblBG">لون الخلفية لملف JPG (للمناطق الشفافة)</label>
              <input type="color" id="bgColor" value="#ffffff" aria-label="لون الخلفية لـ JPG" />
              <div class="hint" id="bgHint">يُستخدم فقط عند اختيار JPG.</div>
            </div>

            <!-- تغيير الحجم -->
            <div id="resizeWrap">
              <label class="small" for="resizeMode" id="lblResize">تغيير الحجم قبل التحويل (اختياري)</label>
              <select id="resizeMode" aria-label="اختر وضع تغيير الحجم">
                <option value="none" selected>بدون تغيير</option>
                <option value="percent">نسبة مئوية</option>
                <option value="maxw">أقصى عرض (بكسل)</option>
              </select>
              <div class="hint" id="resizeHint">قلّل الحجم لتسريع المعالجة على الأجهزة محدودة الذاكرة.</div>
            </div>
          </div>

          <!-- حقول تغيير الحجم الديناميكية -->
          <div class="controls" id="resizeInputs" style="margin-top:-6px;">
            <div id="percentWrap" style="display:none">
              <label class="small" for="percentVal" id="lblPercent">النسبة المئوية</label>
              <input type="number" id="percentVal" min="10" max="200" step="10" value="100" aria-label="قيمة النسبة المئوية" />
              <div class="hint">‏100% = الحجم الأصلي</div>
            </div>
            <div id="maxwWrap" style="display:none">
              <label class="small" for="maxWidth" id="lblMaxW">أقصى عرض (بكسل)</label>
              <input type="number" id="maxWidth" min="128" step="32" value="1000" aria-label="أقصى عرض بالبكسل" />
              <div class="hint">المحافظة على نسبة الأبعاد. الارتفاع يُضبط تلقائيًا.</div>
            </div>
            <div>
              <label class="small">&nbsp;</label>
              <div class="progress" aria-label="شريط التقدم" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><span id="progressBar"></span></div>
              <div class="hint" id="progressText" role="status" aria-live="polite">0%</div>
            </div>
          </div>

          <div class="buttons">
            <input type="file" id="picker" accept="image/*,.ico" multiple hidden />
            <button class="btn" id="pickBtn" type="button" aria-label="اختر الملفات / Choose files"><span class="icon-emoji" aria-hidden="true">📂</span><span class="btn-label">اختر الملفات</span></button>
<button class="btn secondary" id="clearBtn" type="button" aria-label="مسح القائمة / Clear list"><span class="icon-emoji" aria-hidden="true">🧹</span><span class="btn-label">مسح القائمة</span></button>
            <span class="hint" id="privacyNote">مجاني · بدون تسجيل · كل المعالجة داخل متصفحك.</span>
          </div>

          <div class="card" style="margin-top:12px">
            <div class="pad">
              <div class="drop" id="drop" aria-label="منطقة إفلات الصور">
                <strong id="dropTitle">اسحب وأفلت الصور هنا</strong>
                <div id="dropHint" class="hint">JPG, PNG, WebP, ICO — يدعم الدُفعات. *تعمل مع الصور الكبيرة؛ الحد فقط هو ذاكرة جهازك.</div>
              </div>
            </div>
          </div>

          <!-- المعاينة الحيّة -->
          <section class="card" id="livePreview" style="margin-top:12px; display:none" aria-live="polite">
            <div class="pad">
              <h3 id="previewTitle">معاينة حيّة</h3>
              <div class="preview-grid">
                <div class="preview-card">
                  <h4 id="prevOriginalTitle" style="margin:6px 0">الأصلي</h4>
                  <canvas id="prevOrig" class="preview-canvas" aria-label="معاينة الأصل"></canvas>
                  <div class="preview-meta" id="metaOrig"></div>
                </div>
                <div class="preview-card">
                  <h4 id="prevOutputTitle" style="margin:6px 0">الإخراج</h4>
                  <canvas id="prevOut" class="preview-canvas" aria-label="معاينة الإخراج"></canvas>
                  <div class="preview-meta" id="metaOut"></div>
                </div>
              </div>
            </div>
          </section>

          <div class="buttons" style="margin-top:12px">
            <button class="btn" id="convertBtn" type="button" aria-label="Start conversion / بدء التحويل"><span class="icon-emoji" aria-hidden="true">⚡</span><span class="btn-label">تحويل</span></button>
<button class="btn secondary" id="zipBtn" type="button" aria-label="Download all as ZIP / تنزيل الكل كـ ZIP" aria-disabled="true" disabled><span class="icon-emoji" aria-hidden="true">🗜️</span><span class="btn-label">تنزيل الكل (ZIP)</span></button>
          </div>

          <!-- إعلان داخل المحتوى -->
          <div class="ad-slot incontent" style="margin:12px 0;" aria-label="إعلان">
            <span>مساحة إعلان — داخل المحتوى / متجاوب</span>
          </div>

          <div class="card" style="margin-top:8px">
            <div class="pad">
              <table class="list" id="fileTable" aria-label="الملفات">
                <thead>
                  <tr>
                    <th scope="col">معاينة</th><th scope="col">الملف</th><th class="nowrap" scope="col">الأصلي</th><th class="nowrap" scope="col">الإخراج</th><th scope="col">الحالة</th><th scope="col">تنزيل</th>
                  </tr>
                </thead>
                <tbody id="fileBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="pad">
          <div class="ad-slot sidebar" aria-label="إعلان">
            <span>مساحة إعلان — 300×250 / متجاوب</span>
          </div>
          <h3 style="margin-top:18px" id="faqTitle">ملاحظات</h3>
          <ul id="faqList" style="margin-top:8px; padding-inline-start:18px">
            <li>مجاني دائمًا. لا حاجة لحساب.</li>
            <li>لا يوجد رفع ملفات — كل المعالجة محليًا عبر Canvas.</li>
            <li>يدعم الصور الكبيرة؛ حدود جهازك/المتصفح تنطبق.</li>
            <li>تغيير الحجم (نسبة مئوية أو أقصى عرض) لتسريع المعالجة.</li>
            <li>شريط الجودة لـ JPG/WebP يتحكم بالضغط (0.1–1.0).</li>
            <li>مخرجات ICO هي ‎PNG واحدة 256×256 داخل حاوية ICO.</li>
            <li>المناطق الشفافة تتحول إلى اللون الذي تختاره في JPG.</li>
          </ul>
        </div>
      </aside>
    </div>

    <section class="card" id="blogLinks" style="margin-top:16px">
      <div class="pad">
        <h3>من المدوّنة</h3>
        <ul style="padding-inline-start:18px;margin-top:8px">
          <!-- روابط إنجليزية من الجذر -->
          <li><a href="/ar/jpg-to-png-ar.html">كيفية تحويل JPG إلى PNG بدون فقدان الجودة</a></li>
          <li><a href="/ar/jpg-vs-png-vs-webp-ar.html">ما الفرق بين JPG وPNG وWebP؟</a></li>
          <li><a href="/ar/free-tools-ar.html">أفضل 5 أدوات مجانية لتحويل الصور أونلاين (ولماذا أداتنا مختلفة)</a></li>
          <li><a href="/ar/png-to-ico-ar.html">كيفية تحويل الصور إلى ICO لاستخدامها كأيقونة موقع في ثوانٍ</a></li>
          <li><a href="/ar/batch-conversion-ar.html">التحويل الدفعي للصور: وفّر الوقت بتحويل عدة صور دفعة واحدة</a></li>
          <li><a href="/ar/webp-better-ar.html">لماذا صيغة WebP أفضل لأداء الويب</a></li>
          <li><a href="/ar/reduce-image-size-ar.html">كيفية تقليل حجم الصورة بدون فقدان الجودة (دليل تغيير الحجم)</a></li>
          <li><a href="/ar/offline-vs-online-ar.html">محوّل الصور أوفلاين مقابل الأدوات أونلاين: أيهما أفضل؟</a></li>
          <li><a href="/ar/transparent-jpg-ar.html">كيفية إنشاء صور JPG بخلفية شفافة</a></li>
          <li><a href="/ar/best-format-2025-ar.html">الدليل الكامل لاختيار صيغة الصورة المناسبة في عام 2025</a></li>
        </ul>
      </div>
    </section>

    <!-- FAQ مرئي مطابق للـ JSON-LD -->
    <section class="card" id="faq-ui" style="margin-top:16px">
      <div class="pad">
        <h3>الأسئلة الشائعة</h3>
        <details><summary>كيف أحوّل JPG إلى PNG مجانًا؟</summary>
          <p>اسحب وأسقط ملف JPG، اختر PNG كصيغة إخراج، ثم اضغط تحويل. لا حاجة للتسجيل أو الرفع.</p>
        </details>
        <details><summary>هل أستطيع تحويل WebP إلى ICO بدون تسجيل؟</summary>
          <p>نعم. اختر صورة WebP، وحدّد الإخراج ICO (‏256×256)، ثم نزّله فورًا. كل شيء يعمل داخل متصفحك.</p>
        </details>
        <details><summary>هل يدعم الأداة الصور الكبيرة؟</summary>
          <p>نعم. تتم المعالجة محليًا عبر Canvas API. الحد الأساسي هو ذاكرة جهازك.</p>
        </details>
        <details><summary>هل الأداة مجانية دائمًا وبدون حساب؟</summary>
          <p>نعم، مجانية 100% ومدعومة بالإعلانات. لا يتطلب حسابًا أو تسجيلًا.</p>
        </details>
        <details><summary>هل يمكن تحويل عدة صور دفعة واحدة وتنزيلها كملف ZIP؟</summary>
          <p>نعم. أضف عدة ملفات، اضغط تحويل، ثم يمكنك تنزيل كل ملف أو تنزيل الكل كأرشيف ZIP.</p>
        </details>
      </div>
    </section>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite">✅ تم إكمال التحويل</div>

  <footer class="wrap">
    <div>© <span id="year"></span> Free Image Converter — يعمل بالكامل داخل المتصفح ·
      <a href="#" data-modal="aboutDlg">حول</a> ·
      <a href="#" data-modal="privacyDlg">الخصوصية</a> ·
      <a href="#" data-modal="termsDlg">الشروط</a> ·
      <a href="#" data-modal="contactDlg">اتصل بنا</a>
      · <a href="/blog.html">المدوّنة</a>
    </div>
  </footer>

  <!-- الحوارات -->
  <dialog id="aboutDlg"><div class="pad">
    <h3>حول</h3>
    <p>محوّل صور مجاني، مدعوم بالإعلانات، يعمل محليًا داخل المتصفح. بدون تسجيل وبدون رفع. صُمّم للسرعة والخصوصية.</p>
    <div class="modal-actions"><button class="btn secondary" data-close type="button">إغلاق</button></div>
  </div></dialog>

  <dialog id="privacyDlg"><div class="pad">
    <h3>سياسة الخصوصية</h3>
    <p>كل معالجة الصور تتم محليًا داخل متصفحك عبر Canvas API. لا نقوم برفع ملفاتك أو تخزينها على أي خادم. قد تضع سكربتات التحليلات ملفات تعريف الارتباط وفق سياسات Google.</p>
    <div class="modal-actions"><button class="btn secondary" data-close type="button">إغلاق</button></div>
  </div></dialog>

  <dialog id="termsDlg"><div class="pad">
    <h3>شروط الخدمة</h3>
    <p>الخدمة “كما هي” دون ضمانات. أنت مسؤول عن ضمان امتلاكك حقوق معالجة وتنزيل الصور التي تقوم بتحويلها.</p>
    <div class="modal-actions"><button class="btn secondary" data-close type="button">إغلاق</button></div>
  </div></dialog>

  <!-- نموذج اتصال (Formspree) -->
  <dialog id="contactDlg"><div class="pad">
    <h3>اتصل بنا</h3>
    <p class="hint" style="margin-top:-4px">أرسل رسالة عبر النموذج الآمن أدناه. لا نعرض بريدًا مباشرًا لتقليل الرسائل غير المرغوب فيها.</p>
    <form id="contactForm" novalidate>
      <input type="text" name="_gotcha" autocomplete="off" style="display:none" tabindex="-1" />
      <label class="small">بريدك الإلكتروني</label>
      <input type="email" id="cfEmail" name="email" required placeholder="you@example.com" />
      <label class="small" style="margin-top:8px">رسالتك</label>
      <textarea id="cfMsg" name="message" rows="5" required placeholder="كيف يمكننا المساعدة؟"></textarea>
      <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
        <button type="submit" class="btn" id="cfSubmit">إرسال</button>
        <span class="hint" id="cfStatus" aria-live="polite"></span>
      </div>
    </form>
    <p class="hint" style="margin-top:10px">لن نرفع صورك أبدًا. قد تضع الإعلانات ملفات تعريف الارتباط وفق سياسات Google.</p>
    <div class="modal-actions"><button class="btn secondary" data-close type="button">إغلاق</button></div>
  </div></dialog>

  <script>
    // أدوات مساعدة وحالة
    const $ = s => document.querySelector(s);
    const fileBody = $('#fileBody');
    const progressBar = $('#progressBar');
    const progressText = $('#progressText');
    const state = { files: [], zip: null, convertedCount: 0 };
    let idCounter = 0;

    function setTheme(mode){
      document.documentElement.removeAttribute('data-theme');
      if(mode==='light' || mode==='dark'){ document.documentElement.setAttribute('data-theme', mode); }
      $('#themeLight').setAttribute('aria-pressed', mode==='light');
      $('#themeDark').setAttribute('aria-pressed', mode==='dark');
      $('#themeAuto').setAttribute('aria-pressed', mode!=='light' && mode!=='dark');
      try{ localStorage.setItem('theme', mode); }catch{}
    }

    function makeRow(item){
      const tr=document.createElement('tr');
      tr.id=`row-${item.id}`;
      const alt = "صورة مُصغّرة: " + (item.file?.name || "image");
      tr.innerHTML=`
        <td><img class="thumb" src="${item.thumbUrl}" alt="${alt}" loading="lazy" decoding="async"></td>
        <td class="nowrap">${item.file.name}</td>
        <td>${Math.round(item.imgW)}×${Math.round(item.imgH)}</td>
        <td id="out-${item.id}">—</td>
        <td id="st-${item.id}" aria-live="polite">—</td>
        <td id="dl-${item.id}">—</td>`;
      return tr;
    }

    function humanSize(b){const u=["B","KB","MB","GB"];let i=0,n=b;while(n>=1024&&i<u.length-1){n/=1024;i++}return `${n.toFixed(n<10&&i>0?2:0)} ${u[i]}`}

    function toast(){const el=$('#toast');el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2600)}
    function updateRowStatus(id,txt){const el=$(`#st-${id}`); if(el) el.textContent=txt}
    function setOutInfo(id,txt){const el=$(`#out-${id}`); if(el) el.textContent=txt}
    function setDownloadBtn(id,name,blob){
      const td=$(`#dl-${id}`); if(!td) return;
      td.innerHTML='';
      const b=document.createElement('button');
      b.className='btn secondary';
      b.textContent='تنزيل';
      b.setAttribute('aria-label', 'تنزيل ' + name);
      b.addEventListener('click',()=>saveAs(blob,name));
      td.appendChild(b)
    }

    async function analyzeFile(file){
      const url=URL.createObjectURL(file);
      try{
        const bmp=await createImageBitmap(file, { imageOrientation: 'from-image' }).catch(()=>null);
        if(bmp){
          const width=bmp.width,height=bmp.height;
          let tCanvas,ctx;
          if(typeof OffscreenCanvas!=='undefined'){tCanvas=new OffscreenCanvas(52,52); ctx=tCanvas.getContext('2d')}
          else{tCanvas=document.createElement('canvas'); tCanvas.width=52; tCanvas.height=52; ctx=tCanvas.getContext('2d')}
          const scale=Math.min(52/width,52/height), w=Math.max(1,Math.round(width*scale)), h=Math.max(1,Math.round(height*scale));
          ctx.clearRect(0,0,52,52);
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(bmp,(52-w)/2,(52-h)/2,w,h);
          const blob=tCanvas.convertToBlob? await tCanvas.convertToBlob() : await new Promise(r=>tCanvas.toBlob(r,'image/png'));
          const thumbUrl=URL.createObjectURL(blob);
          bmp.close?.();
          return { url, imgW: width, imgH: height, thumbUrl };
        }else{
          const img=await new Promise((res,rej)=>{const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=url;});
          const c=document.createElement('canvas'); c.width=52; c.height=52; const ctx=c.getContext('2d');
          const scale=Math.min(52/img.width,52/img.height), w=Math.max(1,Math.round(img.width*scale)), h=Math.max(1,Math.round(img.height*scale));
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(img,(52-w)/2,(52-h)/2,w,h);
          const blob=await new Promise(r=>c.toBlob(r,'image/png'));
          const thumbUrl=URL.createObjectURL(blob);
          return { url, imgW: img.width, imgH: img.height, thumbUrl };
        }
      }catch(e){ URL.revokeObjectURL(url); throw e; }
    }

    function extFor(fmt){ return fmt==='jpg'?'jpg':fmt==='ico'?'ico':fmt; }
    function mimeFor(fmt){ return fmt==='jpg'?'image/jpeg':fmt==='png'?'image/png':fmt==='webp'?'image/webp':'image/png'; }

    async function wrapPngAsIco(pngBlob){
      const png=new Uint8Array(await pngBlob.arrayBuffer());
      const headerSize=22; const out=new Uint8Array(headerSize+png.length); const dv=new DataView(out.buffer);
      dv.setUint16(0,0,true); dv.setUint16(2,1,true); dv.setUint16(4,1,true);
      out[6]=0; out[7]=0; out[8]=0; out[9]=0;
      dv.setUint16(10,1,true); dv.setUint16(12,32,true);
      dv.setUint32(14,png.length,true); dv.setUint32(18,headerSize,true);
      out.set(png, headerSize);
      return new Blob([out], { type:'image/x-icon' });
    }

    function applyResizeDims(srcW, srcH){
      const mode=$('#resizeMode').value;
      if(mode==='percent'){
        const p=Math.max(10, Math.min(200, parseInt($('#percentVal').value||'100',10)));
        return { w: Math.max(1, Math.round(srcW*p/100)), h: Math.max(1, Math.round(srcH*p/100)) };
      }
      if(mode==='maxw'){
        const maxW=Math.max(64, parseInt($('#maxWidth').value||'1000',10));
        if(srcW<=maxW) return { w: srcW, h: srcH };
        const scale=maxW/srcW;
        return { w: Math.round(srcW*scale), h: Math.round(srcH*scale) };
      }
      return { w: srcW, h: srcH };
    }

    function uniqueName(base, ext, used){
      let name = `${base}.${ext}`, i=1;
      while(used.has(name)){ name = `${base} (${i++}).${ext}`; }
      used.add(name); return name;
    }

    function acceptFiles(files){
      const okTypes = /^(image\/(png|jpeg|webp|avif|gif|bmp|x-icon|vnd\.microsoft\.icon))$/i;
      return Array.from(files).filter(f => okTypes.test(f.type) || /\.ico$/i.test(f.name));
    }

    async function addFiles(files){
      const accepted = acceptFiles(files);
      for(const file of accepted){
        const info=await analyzeFile(file).catch(()=>null);
        if(!info) continue;
        const item={ id:++idCounter, file, url:info.url, thumbUrl:info.thumbUrl, imgW:info.imgW, imgH:info.imgH, status:'pending', outBlob:null, outName:null };
        state.files.push(item);
        fileBody.appendChild(makeRow(item));
        updateRowStatus(item.id,'—');
      }
      $('#zipBtn').disabled=true;
      $('#zipBtn').setAttribute('aria-disabled','true');
      updateProgress(0, state.files.length);
      updatePreview();
    }

    function clearList(){
      state.files.forEach(f=>{ URL.revokeObjectURL(f.url); URL.revokeObjectURL(f.thumbUrl); });
      state.files = [];
      state.zip = null;
      state.convertedCount = 0;
      fileBody.innerHTML = '';
      $('#zipBtn').disabled = true;
      $('#zipBtn').setAttribute('aria-disabled','true');
      updateProgress(0,0);
      if (livePreview) livePreview.style.display = 'none';
      if (prevOrig && prevOrig.width && prevOrig.height) prevOrig.getContext('2d').clearRect(0,0,prevOrig.width,prevOrig.height);
      if (prevOut && prevOut.width && prevOut.height) prevOut.getContext('2d').clearRect(0,0,prevOut.width,prevOut.height);
      if (metaOrig) metaOrig.textContent=''; if (metaOut) metaOut.textContent='';
    }

    function updateProgress(done, total){
      const pct = total? Math.round((done/total)*100) : 0;
      progressBar.style.width = pct + '%';
      progressText.textContent = pct + '%';
      const bar = document.querySelector('.progress');
      if (bar){
        bar.setAttribute('role','progressbar');
        bar.setAttribute('aria-valuemin','0'); bar.setAttribute('aria-valuemax','100');
        bar.setAttribute('aria-valuenow', String(pct));
      }
    }

    async function convertOne(item, fmt, quality, bgColor){
      const bmp=await createImageBitmap(item.file, { imageOrientation: 'from-image' }).catch(()=>null);
      const sourceW=bmp?bmp.width:item.imgW, sourceH=bmp?bmp.height:item.imgH;
      const dims=applyResizeDims(sourceW, sourceH);
      const targetW = (fmt==='ico') ? 256 : dims.w;
      const targetH = (fmt==='ico') ? 256 : dims.h;

      let canvas=document.createElement('canvas'), ctx=canvas.getContext('2d');
      canvas.width=targetW; canvas.height=targetH;

      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';

      if(fmt==='ico'){
        ctx.clearRect(0,0,256,256);
        const scale=Math.min(256/sourceW,256/sourceH);
        const w=Math.max(1,Math.round(sourceW*scale)), h=Math.max(1,Math.round(sourceH*scale));
        const dx=(256-w)/2, dy=(256-h)/2;
        if(bmp) ctx.drawImage(bmp,dx,dy,w,h);
        else{const img=new Image(); img.src=item.url; await img.decode(); ctx.drawImage(img,dx,dy,w,h);}
        const pngBlob=await window.toBlobSafe(canvas,'image/png',1);
        const icoBlob=await wrapPngAsIco(pngBlob);
        bmp?.close?.();
        return { blob: icoBlob, outW:256, outH:256 };
      }

      if(fmt==='jpg'){ ctx.fillStyle=bgColor||'#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height); }
      else{ ctx.clearRect(0,0,canvas.width,canvas.height); }

      if(bmp) ctx.drawImage(bmp,0,0,sourceW,sourceH,0,0,targetW,targetH);
      else{ const img=new Image(); img.src=item.url; await img.decode(); ctx.drawImage(img,0,0,sourceW,sourceH,0,0,targetW,targetH); }
      bmp?.close?.();

      const mime=mimeFor(fmt); const q=(fmt==='jpg'||fmt==='webp')?quality:undefined;
      const blob = await window.toBlobSafe(canvas, mime, q);
      return { blob, outW: targetW, outH: targetH };
    }

    async function runConversion(){
      if (!state.files.length) return;
      await ensureZipLibs();
      state.zip = new JSZip();
      state.convertedCount = 0;

      const fmt     = $('#fmtSelect').value;
      const quality = parseFloat($('#quality').value);
      const bg      = $('#bgColor').value;

      for (const item of state.files) updateRowStatus(item.id, 'جارٍ المعالجة…');

      let done = 0, total = state.files.length;
      updateProgress(0, total);

      const usedNames = new Set();

      for (const item of state.files) {
        try {
          const base    = item.file.name.replace(/\.[^.]+$/, '') || 'image';
          const outName = uniqueName(base, extFor(fmt), usedNames);

          const { blob, outW, outH } = await convertOne(item, fmt, quality, bg);

          item.outBlob = blob;
          item.outName = outName;

          setOutInfo(item.id, `${outW}×${outH} (${humanSize(blob.size)})`);
          setDownloadBtn(item.id, outName, blob);
          updateRowStatus(item.id, 'جاهز');

          state.zip.file(outName, blob);
          state.convertedCount++;
        } catch (e) {
          console.error(e);
          updateRowStatus(item.id, 'فشل');
        }

        done++;
        updateProgress(done, total);
      }

      const zipBtn = $('#zipBtn');
      const canZip = state.convertedCount > 0;
      zipBtn.disabled = !canZip;
      zipBtn.setAttribute('aria-disabled', canZip ? 'false' : 'true');

      if (canZip) toast();
      updatePreview();
    }

    async function downloadZip(){
      if(!state.convertedCount) return;
      await ensureZipLibs();
      const blob=await state.zip.generateAsync({ type:'blob', streamFiles:true });
      saveAs(blob, 'converted_images.zip');
    }

    // نموذج الاتصال (Formspree)
    const FS_ENDPOINT = "https://formspree.io/f/mzzvqonw";
    (function wireContactForm(){
      const form = document.getElementById('contactForm');
      if (!form) return;

      const emailEl = document.getElementById('cfEmail');
      const msgEl = document.getElementById('cfMsg');
      const statusEl = document.getElementById('cfStatus');
      const btn = document.getElementById('cfSubmit');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        statusEl.textContent = '';

        if (!FS_ENDPOINT) { statusEl.textContent = 'الرسائل غير متاحة مؤقتًا. حاول لاحقًا.'; return; }
        if (!emailEl.checkValidity()) { statusEl.textContent = 'من فضلك أدخل بريدًا صحيحًا.'; return; }
        if (!msgEl.value.trim()) { statusEl.textContent = 'اكتب رسالتك أولًا.'; return; }

        btn.disabled = true; btn.textContent = 'جارٍ الإرسال…';
        try {
          const data = new FormData(form);
          data.append('_subject', 'Contact from Free Image Converter (AR)');
          data.append('_replyto', emailEl.value);

          const res = await fetch(FS_ENDPOINT, { method: 'POST', body: data, headers: { 'Accept': 'application/json' } });

          if (res.ok) {
            statusEl.textContent = 'تم الإرسال!';
            try { const t = document.getElementById('toast'); const old=t.textContent; t.textContent='✅ تم إرسال الرسالة'; t.classList.add('show'); setTimeout(()=>{ t.textContent=old; t.classList.remove('show'); }, 2000);} catch {}
            form.reset();
          } else {
            const j = await res.json().catch(()=> ({}));
            statusEl.textContent = j?.error || 'فشل الإرسال. حاول مرة أخرى.';
          }
        } catch (err) {
          console.error(err);
          statusEl.textContent = 'خطأ في الشبكة. حاول مرة أخرى.';
        } finally {
          btn.disabled = false; btn.textContent = 'إرسال';
        }
      });
    })();

    // ربط الأحداث
    $('#pickBtn').addEventListener('click',()=>$('#picker').click());
    $('#picker').addEventListener('change',e=>addFiles(e.target.files));
    $('#clearBtn').addEventListener('click',clearList);
    $('#convertBtn').addEventListener('click',runConversion);
    $('#zipBtn').addEventListener('click',downloadZip);
    $('#quality').addEventListener('input',e=>$('#qualityVal').textContent=(+e.target.value).toFixed(2));

    const drop=$('#drop');
    ['dragenter','dragover'].forEach(evt=>drop.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();drop.classList.add('dragover')}))
    ;['dragleave','drop'].forEach(evt=>drop.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('dragover')}))
    drop.addEventListener('drop',e=>{const dt=e.dataTransfer; if(dt?.files?.length) addFiles(dt.files)});

    // منع فتح الملف عند إفلاته خارج المنطقة
    ['dragover','drop'].forEach(evt=>{
      window.addEventListener(evt, e=>{ e.preventDefault(); });
    });

    function toggleControls(){
      const fmt=$('#fmtSelect').value;
      $('#qualityWrap').style.display=(fmt==='jpg'||fmt==='webp')?'':'none';
      $('#bgWrap').style.display=(fmt==='jpg')?'':'none';
    }
    $('#fmtSelect').addEventListener('change', toggleControls); toggleControls();

    function toggleResizeUI(){
      const mode=$('#resizeMode').value;
      $('#percentWrap').style.display = (mode==='percent')?'':'none';
      $('#maxwWrap').style.display = (mode==='maxw')?'':'none';
    }
    $('#resizeMode').addEventListener('change', toggleResizeUI); toggleResizeUI();

    // السمة
    const savedTheme = (()=>{ try{ return localStorage.getItem('theme') || 'auto'; }catch{ return 'auto'; } })();
    setTheme(savedTheme);
    $('#themeLight').addEventListener('click',()=>setTheme('light'));
    $('#themeDark').addEventListener('click',()=>setTheme('dark'));
    $('#themeAuto').addEventListener('click',()=>setTheme('auto'));

    // السنة
    $('#year').textContent=new Date().getFullYear();

    // الحوارات
    document.querySelectorAll('a[data-modal]').forEach(a=>{
      a.addEventListener('click', e=>{
        e.preventDefault();
        const id=a.getAttribute('data-modal'); const dlg=document.getElementById(id);
        dlg?.showModal();
      });
    });
    document.querySelectorAll('dialog [data-close]').forEach(b=>{
      b.addEventListener('click', e=> e.target.closest('dialog')?.close());
    });
  </script>

  <script>
    // المعاينة الحيّة
    const livePreview = document.getElementById('livePreview');
    const prevOrig = document.getElementById('prevOrig');
    const prevOut  = document.getElementById('prevOut');
    const metaOrig = document.getElementById('metaOrig');
    const metaOut  = document.getElementById('metaOut');

    function maxFit(w, h, maxW=520, maxH=360){
      const s = Math.min(maxW / w, maxH / h, 1);
      return { w: Math.max(1, Math.round(w * s)), h: Math.max(1, Math.round(h * s)) };
    }

    async function drawToCanvas(canvas, bmp, targetW, targetH, bg=null){
      if (!canvas) return;
      canvas.width = targetW; canvas.height = targetH;
      const ctx = canvas.getContext('2d', { alpha: true });
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      if (bg){
        ctx.fillStyle = bg;
        ctx.fillRect(0,0,targetW,targetH);
      }else{
        ctx.clearRect(0,0,targetW,targetH);
      }
      ctx.drawImage(bmp, 0, 0, bmp.width, bmp.height, 0, 0, targetW, targetH);
      return canvas;
    }

    function mimeFor(fmt){ return fmt==='jpg'?'image/jpeg':fmt==='png'?'image/png':fmt==='webp'?'image/webp':'image/png'; }

    async function updatePreview(){
      if (!livePreview) return;
      if (!state.files.length){
        livePreview.style.display = 'none';
        return;
      }
      try{
        const item = state.files[0];
        const bmp  = await createImageBitmap(item.file, { imageOrientation: 'from-image' }).catch(()=>null);
        if (!bmp){ livePreview.style.display='none'; return; }

        const fitO = maxFit(bmp.width, bmp.height);
        await drawToCanvas(prevOrig, bmp, fitO.w, fitO.h, null);
        if (metaOrig) metaOrig.textContent = `${Math.round(bmp.width)}×${Math.round(bmp.height)} • ${humanSize(item.file.size)}`;

        const fmt     = document.getElementById('fmtSelect').value;
        const q       = parseFloat(document.getElementById('quality').value) || 0.92;
        const bg      = (fmt === 'jpg') ? document.getElementById('bgColor').value : null;

        const dims    = applyResizeDims(bmp.width, bmp.height);
        const targetW = (fmt==='ico') ? 256 : dims.w;
        const targetH = (fmt==='ico') ? 256 : dims.h;

        const temp = document.createElement('canvas');
        await drawToCanvas(temp, bmp, targetW, targetH, bg);
        let blob = await window.toBlobSafe(temp, mimeFor(fmt), (fmt==='jpg' || fmt==='webp') ? q : undefined);

        const outBmp = await createImageBitmap(blob);
        const fitOut  = maxFit(targetW, targetH);
        await drawToCanvas(prevOut, outBmp, fitOut.w, fitOut.h, null);
        outBmp.close?.();

        if (metaOut) metaOut.textContent = `${targetW}×${targetH} • ${humanSize(blob.size)}`;

        livePreview.style.display = '';
        bmp.close?.();
      }catch(e){
        console.error(e);
        livePreview.style.display = 'none';
      }
    }

    ['#fmtSelect','#quality','#bgColor','#resizeMode','#percentVal','#maxWidth'].forEach(sel=>{
      const el = document.querySelector(sel);
      if (el) el.addEventListener('input', updatePreview);
      if (el) el.addEventListener('change', updatePreview);
    });
    setTimeout(updatePreview, 0);
  </script>

  <!-- أحداث GA -->
  <script>
    document.addEventListener("DOMContentLoaded", function(){
      var cBtn = document.getElementById("convertBtn");
      var zBtn = document.getElementById("zipBtn");
      var cForm = document.getElementById("contactForm");

      if (cBtn) cBtn.addEventListener("click", function(){
        window.gtag && gtag("event", "convert_click", {event_category:"engagement", value:1});
      });

      if (zBtn) zBtn.addEventListener("click", function(){
        window.gtag && gtag("event", "zip_download", {event_category:"engagement", value:1});
      });

      if (cForm) cForm.addEventListener("submit", function(){
        window.gtag && gtag("event", "contact_submit", {event_category:"lead", value:1});
      });
    });
  </script>

  <!-- toBlobSafe -->
  <script>
  (function(){
    if (window.__toBlobSafeInstalled) return; window.__toBlobSafeInstalled = true;
    window.toBlobSafe = function(canvas, mime, q){
      return new Promise(function(resolve){
        try {
          canvas.toBlob(function(b){
            if(!b && mime === 'image/webp'){
              canvas.toBlob(function(b2){ resolve(b2); }, 'image/png', 1);
            } else {
              resolve(b);
            }
          }, mime, q);
        } catch(e){
          canvas.toBlob(function(b2){ resolve(b2); }, 'image/png', 1);
        }
      });
    };
  })();
  </script>

  <script>
    // Service Worker (من نفس الجذر)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => {
            if (navigator.serviceWorker.controller) {
              try { navigator.serviceWorker.controller.postMessage('SKIP_WAITING'); } catch {}
            }
          })
          .catch(console.error);
      });
    }
  </script>
</body>
</html>
